<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Starlight AR Experience</title>
  <style>
    body, html {
      margin: 0; padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: black;
      height: 100%;
    }
    #barrage-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      pointer-events: none;
      display: none;
      z-index: 2;
    }
    .barrage {
      position: absolute;
      white-space: nowrap;
      font-size: 20px;
      color: white;
      text-shadow: 0 0 5px black;
      animation: moveLeft 9s linear forwards;
    }
    @keyframes moveLeft {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }
    #messageForm {
      position: fixed;
      bottom: 10px; left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 3;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 12px;
      align-items: center;
    }
    #messageInput {
      width: 180px; padding: 6px;
      border-radius: 8px; border: none;
    }
    #sendButton {
      margin-left: 8px;
      padding: 6px 10px;
      border: none;
      border-radius: 8px;
      background: #1e90ff;
      color: white;
    }
    #imagePreview {
      width: 40px; height: 40px;
      object-fit: cover;
      border-radius: 8px;
      margin-left: 6px;
      display: none;
    }
    #homeButton {
      position: fixed;
      top: 10px; left: 10px;
      z-index: 4;
      background: rgba(255,255,255,0.8);
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
    }
    video {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
      display: none;
    }
  </style>

  <!-- ‚úÖ ËºâÂÖ• MindAR + A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.3.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.6/dist/mindar-image-aframe.prod.js"></script>
</head>

<body>
  <button id="homeButton" onclick="goHome()">üè† ËøîÂõûÈ¶ñÈ†Å</button>

  <!-- ‚úÖ AR Scene -->
  <a-scene
    mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    embedded
  >
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- ÂΩàÂπïÂçÄ Marker 0‚Äì2 -->
    <a-entity mindar-image-target="targetIndex: 0" id="checkpoint-0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1" id="checkpoint-1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2" id="checkpoint-2"></a-entity>

    <!-- Êí≠ÁâáÂçÄ Marker 3‚Äì12 -->
    <a-entity mindar-image-target="targetIndex: 3" id="checkpoint-3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4" id="checkpoint-4"></a-entity>
    <a-entity mindar-image-target="targetIndex: 5" id="checkpoint-5"></a-entity>
    <a-entity mindar-image-target="targetIndex: 6" id="checkpoint-6"></a-entity>
    <a-entity mindar-image-target="targetIndex: 7" id="checkpoint-7"></a-entity>
    <a-entity mindar-image-target="targetIndex: 8" id="checkpoint-8"></a-entity>
    <a-entity mindar-image-target="targetIndex: 9" id="checkpoint-9"></a-entity>
    <a-entity mindar-image-target="targetIndex: 10" id="checkpoint-10"></a-entity>
    <a-entity mindar-image-target="targetIndex: 11" id="checkpoint-11"></a-entity>
    <a-entity mindar-image-target="targetIndex: 12" id="checkpoint-12"></a-entity>
  </a-scene>

  <!-- ‚úÖ ÂΩàÂπï„ÄÅËº∏ÂÖ•ÂçÄ -->
  <div id="barrage-container"></div>
  <div id="messageForm">
    <input type="text" id="messageInput" placeholder="Ëº∏ÂÖ•ÁïôË®Ä..." disabled />
    <input type="file" id="imageInput" accept="image/*" />
    <button id="sendButton" disabled>ÁôºÈÄÅ</button>
    <img id="imagePreview" />
  </div>

  <!-- ‚úÖ ÂΩ±Áâá -->
  <video id="CompVideo" src="Comp.mp4" muted playsinline preload="auto" crossorigin="anonymous"></video>

  <script>
  function goHome() {
    window.location.href = "https://starlightar.webflow.io/";
  }

  const messageMarkers = [
    { id:"checkpoint-0", messages:[], interval:null, rewardKey:"reward_checkpoint0" },
    { id:"checkpoint-1", messages:[], interval:null, rewardKey:"reward_checkpoint1" },
    { id:"checkpoint-2", messages:[], interval:null, rewardKey:"reward_checkpoint2" }
  ];
  const videoMarkers = [
    { id:"checkpoint-3" }, { id:"checkpoint-4" }, { id:"checkpoint-5" },
    { id:"checkpoint-6" }, { id:"checkpoint-7" }, { id:"checkpoint-8" },
    { id:"checkpoint-9" }, { id:"checkpoint-10" }, { id:"checkpoint-11" }, { id:"checkpoint-12" }
  ];

  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendButton");
  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("imagePreview");
  const container = document.getElementById("barrage-container");
  const form = document.getElementById("messageForm");
  const videoEl = document.getElementById("CompVideo");
  let activeMarker = null;

  // ‚úÖ Á¢∫‰øùÂΩ±ÁâáËÉΩËá™ÂãïÊí≠Êîæ
  videoEl.muted = true;
  videoEl.setAttribute("playsinline", true);
  videoEl.setAttribute("autoplay", true);
  document.body.addEventListener("click", () => {
    videoEl.play().catch(e => console.log("autoplay blocked:", e));
  }, { once: true });

  // ËºâÂÖ•Êú¨Âú∞ÂΩàÂπïË≥áÊñô
  messageMarkers.forEach(m=>{
    m.messages = JSON.parse(localStorage.getItem("barrage_" + m.id)||'[]');
  });

  function showBarrage(msg){
    const el=document.createElement("div");
    el.className="barrage";
    el.style.top=Math.random()*(container.offsetHeight-120)+"px";
    if(msg.img){
      const img=document.createElement("img");
      img.src=msg.img;
      img.style.height="30px";
      img.style.borderRadius="6px";
      el.appendChild(img);
      if(msg.text) el.appendChild(document.createTextNode(" "+msg.text));
    } else el.textContent=msg.text;
    container.appendChild(el);
    setTimeout(()=>el.remove(),9000);
  }

  function startBarrage(m){
    if(m.interval) return;
    container.style.display="block";
    let idx=0;
    m.interval=setInterval(()=>{
      if(m.messages.length>0) showBarrage(m.messages[idx]), idx=(idx+1)%m.messages.length;
    },3000);
  }

  function stopBarrage(m){
    if(m.interval){ clearInterval(m.interval); m.interval=null; }
    if(!messageMarkers.some(marker=>marker.interval)) container.style.display="none";
  }

  // ÂΩàÂπï Marker ‰∫ã‰ª∂
  messageMarkers.forEach(m=>{
    const el=document.getElementById(m.id);
    el.addEventListener("targetFound", ()=>{
      activeMarker = m;
      form.style.display = "flex";
      input.disabled = false;
      sendBtn.disabled = false;
      startBarrage(m);
      localStorage.setItem(m.rewardKey,"true");
    });
    el.addEventListener("targetLost", ()=>{
      if(activeMarker===m) activeMarker=null;
      form.style.display="none";
      input.disabled = true;
      sendBtn.disabled = true;
      stopBarrage(m);
    });
  });

  // ÂΩ±Áâá Marker ‰∫ã‰ª∂
  videoMarkers.forEach(v=>{
    const el=document.getElementById(v.id);
    el.addEventListener("targetFound", ()=>{
      videoEl.style.display="block";
      videoEl.currentTime=0;
      videoEl.play().catch(err=>console.log("Play error:",err));
    });
    el.addEventListener("targetLost", ()=>{
      videoEl.pause();
      videoEl.style.display="none";
    });
  });

  // ÂúñÁâáÈ†êË¶Ω
  imageInput.addEventListener("change",()=>{
    const file=imageInput.files[0];
    if(!file){ preview.style.display="none"; return; }
    const reader=new FileReader();
    reader.onload=e=>{ preview.src=e.target.result; preview.style.display="inline"; };
    reader.readAsDataURL(file);
  });

  // ÁôºÈÄÅÁïôË®Ä
  sendBtn.addEventListener("click",()=>{
    if(!activeMarker) return;
    const text=input.value.trim();
    const file=imageInput.files[0];
    if(!text && !file) return;

    const saveMsg=(imgData=null)=>{
      const msg={text,img:imgData};
      activeMarker.messages.push(msg);
      if(activeMarker.messages.length>50) activeMarker.messages.shift();
      localStorage.setItem("barrage_" + activeMarker.id,JSON.stringify(activeMarker.messages));
      showBarrage(msg);
      input.value=""; imageInput.value=""; preview.style.display="none";
    };

    if(file){
      const reader=new FileReader();
      reader.onload=e=>saveMsg(e.target.result);
      reader.readAsDataURL(file);
    } else saveMsg();
  });

  // Enter ÁôºÈÄÅ
  input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendBtn.click(); });
  </script>
</body>
</html>
